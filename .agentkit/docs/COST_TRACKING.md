# AgentKit Forge Cost Tracking Guide

> **Status: PARTIALLY IMPLEMENTED** â€” Session-level tracking (session start/end,
> duration, commands run, files modified) is implemented via lifecycle hooks and
> the `cost` CLI command. Token-level tracking (input/output tokens, estimated
> USD cost) requires AI tool API access and remains on the roadmap.

Session-level usage tracking for AI development workflows. Tracks session duration, commands invoked, and files modified via lifecycle hooks. Token-level cost tracking is a roadmap item.

## What's Implemented

- **Session tracking via hooks:** `session-start.sh` logs session start; `stop-build-check.sh` logs session end with file counts
- **JSONL usage logs:** Daily log files at `.agentkit/logs/usage-YYYY-MM-DD.jsonl`
- **Session files:** Per-session records at `.agentkit/logs/sessions/session-<id>.json`
- **CLI reporting:** `node .agentkit/engines/node/src/cli.mjs cost --summary|--sessions|--report`
- **Monthly aggregation:** Reports by user, command, and time period
- **Export formats:** Table, JSON, and CSV output

## What's Roadmap

- Token-level tracking (input/output/cache tokens, estimated USD cost)
- Budget alerts and limits
- Webhook notifications
- Cache analytics
- Model-specific cost rates

---

## Table of Contents

1. [Overview](#overview)
2. [Token Usage Logging](#token-usage-logging)
3. [Session Tracking](#session-tracking)
4. [Monthly Reports](#monthly-reports)
5. [Optimization Tips](#optimization-tips)
6. [Budget Alerts and Limits](#budget-alerts-and-limits)

---

## Overview

AI coding assistants consume tokens for every interaction -- prompts sent and completions received. Without visibility into this consumption, costs can grow unpredictably. AgentKit Forge provides built-in cost tracking to help teams understand, monitor, and optimize their AI spend.

### Key Concepts

- **Input tokens**: Tokens sent to the AI model (your prompts, context, file contents)
- **Output tokens**: Tokens generated by the AI model (responses, code, explanations)
- **Session**: A single continuous interaction with an AI assistant, from start to finish
- **Cost rate**: The per-token price, which varies by model and provider

---

## Token Usage Logging

### Enabling Token Logging

Token usage logs are written to the `.agentkit/logs/` directory. To enable logging, ensure your overlay `settings.yaml` includes:

```yaml
costTracking:
  enabled: true
  logDir: logs
  granularity: session  # Options: session, command, detailed
```

### Log Format

Each log entry is a JSON line (JSONL format) written to a date-stamped file:

```
.agentkit/logs/usage-2025-01-15.jsonl
```

Each line contains:

```json
{
  "timestamp": "2025-01-15T14:32:00.000Z",
  "sessionId": "abc123",
  "command": "plan",
  "model": "claude-sonnet-4-20250514",
  "provider": "anthropic",
  "inputTokens": 12500,
  "outputTokens": 3200,
  "cacheReadTokens": 8000,
  "cacheWriteTokens": 4500,
  "estimatedCostUSD": 0.0847,
  "durationMs": 4500,
  "user": "developer@example.com",
  "repo": "my-project",
  "branch": "feature/auth"
}
```

### Viewing Recent Usage

Use the CLI to view a summary of recent token usage:

```bash
node agentkit-forge/.agentkit/engines/node/src/cli.mjs cost --summary
```

This outputs a table summarizing usage by day, command, and user.

### Log Rotation

Log files are created per day. To manage disk usage, configure retention:

```yaml
costTracking:
  retentionDays: 90
  compressAfterDays: 7
```

Files older than `retentionDays` are automatically purged. Files older than `compressAfterDays` are gzip-compressed.

---

## Session Tracking

### What Is a Session?

A session begins when an AI assistant starts processing a task and ends when the task completes or the user ends the interaction. Sessions group multiple API calls into a single logical unit of work.

### Session Metadata

Each session records:

| Field | Description |
|-------|-------------|
| `sessionId` | Unique identifier for the session |
| `startTime` | When the session began |
| `endTime` | When the session ended |
| `totalInputTokens` | Sum of all input tokens across API calls |
| `totalOutputTokens` | Sum of all output tokens across API calls |
| `totalCacheReadTokens` | Tokens read from prompt cache |
| `totalCacheWriteTokens` | Tokens written to prompt cache |
| `estimatedTotalCostUSD` | Estimated total cost for the session |
| `commandsRun` | List of AgentKit commands executed |
| `filesModified` | Number of files created or modified |
| `user` | Developer who initiated the session |
| `branch` | Git branch the work was performed on |

### Session Summary Files

Session summaries are written to:

```
.agentkit/logs/sessions/session-<sessionId>.json
```

### Querying Sessions

To list recent sessions with their costs:

```bash
node agentkit-forge/.agentkit/engines/node/src/cli.mjs cost --sessions --last 7d
```

To view details for a specific session:

```bash
node agentkit-forge/.agentkit/engines/node/src/cli.mjs cost --sessions
```

---

## Monthly Reports

### Generating a Monthly Report

Generate a cost report for a given month:

```bash
node agentkit-forge/.agentkit/engines/node/src/cli.mjs cost --report --month 2025-01
```

### Report Contents

The monthly report includes:

#### Summary Section

- Total tokens consumed (input + output)
- Total estimated cost in USD
- Number of sessions
- Average cost per session
- Cost trend compared to the previous month (percentage change)

#### Breakdown by User

| User | Sessions | Input Tokens | Output Tokens | Est. Cost |
|------|----------|-------------|--------------|-----------|
| alice@example.com | 42 | 1,250,000 | 380,000 | $45.20 |
| bob@example.com | 35 | 980,000 | 290,000 | $34.10 |
| **Total** | **77** | **2,230,000** | **670,000** | **$79.30** |

#### Breakdown by Command

| Command | Invocations | Input Tokens | Output Tokens | Est. Cost |
|---------|------------|-------------|--------------|-----------|
| plan | 120 | 800,000 | 250,000 | $30.50 |
| orchestrate | 45 | 650,000 | 180,000 | $22.80 |
| review | 88 | 480,000 | 140,000 | $16.20 |
| discover | 30 | 300,000 | 100,000 | $9.80 |

#### Breakdown by Branch

Useful for understanding cost per feature or workstream.

### Exporting Reports

Export reports in different formats:

```bash
# CSV export for spreadsheets
node agentkit-forge/.agentkit/engines/node/src/cli.mjs cost --report --month 2025-01 --format csv > report.csv

# JSON export for programmatic processing
node agentkit-forge/.agentkit/engines/node/src/cli.mjs cost --report --month 2025-01 --format json > report.json
```

### Automated Monthly Reports

Add a scheduled CI job to generate and distribute monthly reports:

```yaml
# .github/workflows/cost-report.yml
name: Monthly AI Cost Report

on:
  schedule:
    - cron: '0 9 1 * *'  # 9 AM on the 1st of each month

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate cost report
        run: |
          LAST_MONTH=$(date -d "last month" +%Y-%m)
          node agentkit-forge/.agentkit/engines/node/src/cli.mjs cost \
            --report --month "$LAST_MONTH" --format json > report.json

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: cost-report-${{ env.LAST_MONTH }}
          path: report.json
```

---

## Optimization Tips

### 1. Use Prompt Caching Effectively

Prompt caching reduces costs by reusing previously computed context. AgentKit Forge tracks cache hit rates in your usage logs.

- **Cache read tokens** are significantly cheaper than regular input tokens (typically 90% less)
- **Cache write tokens** cost slightly more than regular input tokens on the first call, but save money on subsequent calls
- Structure your workflows so that repeated context (project rules, file contents) benefits from caching

Monitor your cache hit rate:

```bash
node agentkit-forge/.agentkit/engines/node/src/cli.mjs cost --summary
```

Aim for a cache hit rate above 60% for frequently used workflows.

### 2. Scope Context Precisely

The more context you send to the AI, the more input tokens you consume. Reduce costs by:

- Keeping `rules.yaml` entries concise and specific
- Using targeted `scope` patterns in rules to avoid sending irrelevant guidelines
- Excluding large generated files from AI assistant context (e.g., `dist/`, `node_modules/`, lockfiles)

### 3. Choose the Right Model for the Task

Different tasks have different complexity requirements. Configure model selection per command:

```yaml
costTracking:
  modelPreferences:
    discover: claude-haiku    # Low-cost for scanning/discovery
    plan: claude-sonnet       # Mid-range for planning
    orchestrate: claude-opus  # High-capability for complex orchestration
    check: claude-haiku       # Low-cost for validation
```

### 4. Use the Plan Command Before Orchestrate

Running `plan` before `orchestrate` reduces wasted tokens on false starts. A well-formed plan means fewer iterations and corrections during execution.

### 5. Batch Related Operations

Instead of running multiple small AI sessions, batch related tasks into a single `orchestrate` session. This maximizes prompt cache reuse and reduces per-session overhead.

### 6. Review Before Committing to Large Tasks

Use the `review` command to validate AI-generated plans and code before proceeding. Catching issues early avoids expensive redo loops.

### 7. Prune Stale Context

Periodically review your overlay files and remove outdated rules, commands, or settings. Stale context increases token consumption without adding value.

### 8. Monitor Cost Trends

Review monthly reports to identify:

- Spikes in usage that correlate with specific features or team members
- Commands that consume disproportionate tokens relative to their value
- Opportunities to shift expensive operations to cheaper models

---

## Budget Alerts and Limits

### Setting a Budget

Configure budget thresholds in your overlay `settings.yaml`:

```yaml
costTracking:
  budget:
    monthlyLimitUSD: 500
    warningThresholdPercent: 80
    perSessionLimitUSD: 25
    perUserDailyLimitUSD: 50
```

### Alert Behavior

When thresholds are reached:

- **Warning threshold** (e.g., 80% of monthly limit): A warning is displayed at the start of each session
- **Monthly limit**: New sessions display a hard warning and require explicit confirmation to proceed
- **Per-session limit**: The session is paused with a prompt to continue or abort
- **Per-user daily limit**: The user is notified and further sessions require team lead approval

### Integrating with Team Communication

Configure webhook notifications for budget alerts:

```yaml
costTracking:
  alerts:
    webhook: https://hooks.slack.com/services/YOUR/WEBHOOK/URL
    events:
      - warning_threshold_reached
      - monthly_limit_reached
      - unusual_spike_detected
```

### Tracking Costs by Project or Team

For organizations with multiple repositories, aggregate costs across repos by using consistent `repoName` values and collecting logs centrally. Use the JSON export format to feed data into your organization's cost management tools or dashboards.
