# AI Runbook — {{repoName}}

> Operational runbook for AI agent workflows. Covers common scenarios,
> troubleshooting, and recovery procedures.

---

## Table of Contents

1. [Quick Reference](#quick-reference)
2. [Common Workflows](#common-workflows)
3. [Troubleshooting](#troubleshooting)
4. [Recovery Procedures](#recovery-procedures)

---

## Quick Reference

| Command | Purpose |
|---------|---------|
| `agentkit sync` | Regenerate all AI tool configs from spec |
| `agentkit validate` | Check config integrity and security |
| `agentkit discover` | Scan repo and detect tech stacks |
| `agentkit init` | Initialize a new repo overlay |
| `/orchestrate` | Run multi-team coordination workflow |
| `/check` | Run quality gates locally |
| `/review` | Request code review from relevant teams |

---

## Common Workflows

### First-time Setup

1. Clone the repository
2. Run `agentkit init --repoName <name>` to create overlay
3. Edit `agentkit/overlays/<name>/settings.yaml` as needed
4. Run `agentkit sync` to generate all configs
5. Commit the generated files

### Adding a New Team Member (AI Agent)

1. Add agent definition to `agentkit/spec/agents.yaml`
2. Run `agentkit sync` to regenerate agent files
3. Verify with `agentkit validate`

### Updating Permissions

1. Edit `agentkit/overlays/<repo>/settings.yaml`
2. Add entries to `permissions.allow` or `permissions.deny`
3. Run `agentkit sync` — deny entries always win over allow
4. Verify with `agentkit validate`

### Customizing Team Commands

1. Edit `agentkit/overlays/<repo>/commands.yaml`
2. Add command overrides (merged at file level with base spec)
3. Run `agentkit sync`

---

## Troubleshooting

### Sync produces unexpected output

- Run `DEBUG=1 agentkit sync` for verbose logging
- Check for unresolved `{{placeholder}}` warnings
- Verify overlay directory matches `.agentkit-repo` marker

### Validate reports permission issues

- Review `settings.yaml` — deny entries override all matching allow entries
- Ensure no secrets appear in allow lists
- Check that tool patterns match the expected format

### Generated files show as modified after clean sync

- This indicates drift — someone edited a generated file directly
- Run `agentkit sync` to overwrite with canonical version
- Commit the regenerated files

### Hook scripts fail

- Verify `.sh` scripts have executable permissions (`chmod +x`)
- Check that the hook reads JSON from stdin correctly
- Test with: `echo '{"tool":"Write"}' | .claude/hooks/protect-sensitive.sh`

---

## Recovery Procedures

### Restore from bad sync

Generated files include a backup-aware atomic write. If sync fails mid-write:

1. Check for leftover `.tmp/` directory in agentkit root
2. If present, delete it: `rm -rf agentkit/.tmp`
3. Re-run `agentkit sync`

### Reset to clean state

1. Delete all generated files (those with `GENERATED by AgentKit Forge` header)
2. Run `agentkit sync` to regenerate everything
3. Use `git diff` to verify the output

### State file corruption

If `.claude/state/orchestrator.json` becomes corrupted:

1. Delete the file
2. The orchestrator will recreate it on next `/orchestrate` invocation
3. Active session data will be lost — check git history for recovery

---

*This runbook is maintained by AgentKit Forge. Run `pnpm -C agentkit agentkit:sync` to regenerate.*
